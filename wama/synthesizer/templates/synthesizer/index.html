{% extends 'synthesizer/base.html' %}
{% load static %}

{% block title %}Synthesizer - Text To Speech{% endblock %}

{% block synthesizer_content %}
<div class="container-fluid py-4">

    <!-- Upload Zone -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="drop-zone" id="dropZone" data-upload-url="{% url 'synthesizer:upload' %}" data-csrf-token="{{ csrf_token }}">
                <i class="fas fa-file-upload fa-3x mb-3 text-primary"></i>
                <h5>Glissez-déposez vos fichiers texte ici</h5>
                <p class="text mb-3">ou cliquez pour parcourir</p>
                <p class="small text">
                    Formats supportés: TXT, PDF, DOCX, CSV, MD
                </p>
                <input type="file" id="fileInput" multiple accept=".txt,.pdf,.docx,.csv,.md"
                       style="display: none;">
                <button class="btn btn-primary mt-2" id="browseBtn">
                    <i class="fas fa-folder-open"></i> Parcourir
                </button>
            </div>
        </div>
    </div>

    <!-- Options Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="options-panel">
                <h5 class="mb-3"><i class="fas fa-sliders-h"></i> Options de synthèse</h5>
                
                <div class="row">
                    <div class="col-md-3">
                        <label for="tts_model" class="form-label">Modèle TTS</label>
                        <select class="form-select" id="tts_model" name="tts_model">
                            {% for value, label in tts_models %}
                            <option value="{{ value }}" {% if value == 'xtts_v2' %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text">XTTS v2 recommandé pour le clonage de voix</small>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="language" class="form-label">Langue</label>
                        <select class="form-select" id="language" name="language">
                            {% for value, label in languages %}
                            <option value="{{ value }}" {% if value == 'fr' %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="voice_preset" class="form-label">Voix</label>
                        <select class="form-select" id="voice_preset" name="voice_preset">
                            {% for value, label in voice_presets_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="speed" class="form-label">Vitesse: <span id="speed_value">1.0</span>x</label>
                        <input type="range" class="form-range" id="speed" name="speed" 
                               min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="pitch" class="form-label">Hauteur: <span id="pitch_value">1.0</span>x</label>
                        <input type="range" class="form-range" id="pitch" name="pitch" 
                               min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-sm btn-outline-secondary w-100" id="resetOptions">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Voice Reference Upload -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="voice_reference" class="form-label">
                            <i class="fas fa-user-circle"></i> Voix de référence (clonage)
                        </label>
                        <input type="file" class="form-control" id="voice_reference" 
                               accept="audio/*" name="voice_reference">
                        <small class="text">
                            Fichier audio 6-10 sec pour cloner une voix (optionnel)
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <button class="btn btn-success" id="startAllBtn">
                    <i class="fas fa-play"></i> Start Process
                </button>
                <button class="btn btn-info" id="downloadAllBtn">
                    <i class="fas fa-download"></i> Download All
                </button>
                <button class="btn btn-danger" id="clearAllBtn">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
        </div>
    </div>
    
    <!-- Syntheses Queue -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="fas fa-list"></i> File d'attente
                <span class="badge bg-secondary" id="queueCount">{{ syntheses.count }}</span>
            </h4>
            
            <div id="synthesisQueue">
                {% for synthesis in syntheses %}
                <div class="synthesis-card {% if synthesis.status == 'RUNNING' %}processing{% elif synthesis.status == 'SUCCESS' %}success{% elif synthesis.status == 'FAILURE' %}error{% endif %}" 
                     data-id="{{ synthesis.id }}">
                    <div class="row align-items-center">
                        <!-- Text File Info -->
                        <div class="col-md-3">
                            <strong>{{ synthesis.filename }}</strong>
                            <br>
                            <small class="text">
                                {{ synthesis.word_count }} mots • 
                                {{ synthesis.duration_display|default:"--:--" }}
                            </small>
                        </div>
                        
                        <!-- Options -->
                        <div class="col-md-2">
                            <small>
                                <i class="fas fa-robot"></i> {{ synthesis.get_tts_model_display|truncatechars:20 }}<br>
                                <i class="fas fa-language"></i> {{ synthesis.get_language_display }}<br>
                                <i class="fas fa-microphone"></i> {{ synthesis.get_voice_preset_display|truncatechars:15 }}
                            </small>
                        </div>
                        
                        <!-- Properties -->
                        <div class="col-md-2">
                            <small class="text">
                                {{ synthesis.properties|default:"En attente" }}
                            </small>
                        </div>
                        
                        <!-- Status & Progress -->
                        <div class="col-md-2">
                            <span class="badge 
                                {% if synthesis.status == 'PENDING' %}bg-secondary
                                {% elif synthesis.status == 'RUNNING' %}bg-warning
                                {% elif synthesis.status == 'SUCCESS' %}bg-success
                                {% elif synthesis.status == 'FAILURE' %}bg-danger
                                {% endif %}">
                                {{ synthesis.get_status_display }}
                            </span>
                            <div class="progress-bar-custom mt-2">
                                <div class="progress-fill" style="width: {{ synthesis.progress }}%"></div>
                            </div>
                            <small class="text">{{ synthesis.progress }}%</small>
                        </div>
                        
                        <!-- Actions -->
                        <div class="col-md-3">
                            <div class="btn-group-actions">
                                {% if synthesis.status != 'RUNNING' %}
                                <button class="btn btn-sm btn-primary start-btn" 
                                        data-id="{{ synthesis.id }}">
                                    <i class="fas fa-play"></i>
                                </button>
                                {% endif %}
                                
                                {% if synthesis.audio_output %}
                                <button class="btn btn-sm btn-success preview-btn" 
                                        data-id="{{ synthesis.id }}">
                                    <i class="fas fa-volume-up"></i> Preview
                                </button>
                                <a href="{% url 'synthesizer:download' synthesis.id %}" 
                                   class="btn btn-sm btn-info">
                                    <i class="fas fa-download"></i>
                                </a>
                                {% endif %}
                                
                                <button class="btn btn-sm btn-danger delete-btn" 
                                        data-id="{{ synthesis.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Audio Preview (hidden by default) -->
                            <div class="audio-preview mt-2" id="preview_{{ synthesis.id }}" 
                                 style="display: none;">
                                {% if synthesis.audio_output %}
                                <audio controls class="audio-player">
                                    <source src="{{ synthesis.audio_output.url }}" type="audio/wav">
                                </audio>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Aucun fichier dans la file d'attente</p>
                    <p>Uploadez des fichiers texte pour commencer</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-volume-up"></i> Voice Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <audio id="previewAudio" controls class="w-100">
                    <source src="" type="audio/wav">
                </audio>
                <div id="previewInfo" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
    // Inject Django URLs and CSRF token into JavaScript
    window.WAMA_CONFIG = {
        urls: {
            upload: "{% url 'synthesizer:upload' %}",
            start: "/synthesizer/start/",
            progress: "/synthesizer/progress/",
            delete: "/synthesizer/delete/",
            startAll: "{% url 'synthesizer:start_all' %}",
            downloadAll: "{% url 'synthesizer:download_all' %}",
            clearAll: "{% url 'synthesizer:clear_all' %}",
            console: "{% url 'synthesizer:console' %}"
        },
        csrfToken: "{{ csrf_token }}"
    };
</script>
<script src="{% static 'synthesizer/js/index.js' %}"></script>
{% endblock %}