{% extends 'synthesizer/base.html' %}
{% load static %}

{% block title %}Synthesizer - Text To Speech{% endblock %}

{% block app_right_panel_settings %}
<!-- TTS Model -->
<div class="mb-3">
    <label for="tts_model" class="form-label small fw-bold text-light">
        <i class="fas fa-robot"></i> Modèle TTS
    </label>
    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="tts_model" name="tts_model">
        {% for value, label in tts_models %}
        <option value="{{ value }}" {% if value == 'xtts_v2' %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
</div>

<!-- Language -->
<div class="mb-3">
    <label for="language" class="form-label small fw-bold text-light">
        <i class="fas fa-language"></i> Langue
    </label>
    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="language" name="language">
        {% for value, label in languages %}
        <option value="{{ value }}" {% if value == 'fr' %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
</div>

<!-- Voice Preset -->
<div class="mb-3">
    <label for="voice_preset" class="form-label small fw-bold text-light">
        <i class="fas fa-microphone"></i> Voix
    </label>
    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="voice_preset" name="voice_preset">
        {% for value, label in voice_presets_choices %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
    </select>
</div>

<!-- Speed -->
<div class="mb-3">
    <label for="speed" class="form-label small fw-bold text-light">
        <i class="fas fa-tachometer-alt"></i> Vitesse: <span id="speed_value">1.0</span>x
    </label>
    <input type="range" class="form-range" id="speed" name="speed" min="0.5" max="2.0" step="0.1" value="1.0">
</div>

<!-- Pitch -->
<div class="mb-3">
    <label for="pitch" class="form-label small fw-bold text-light">
        <i class="fas fa-wave-square"></i> Hauteur: <span id="pitch_value">1.0</span>x
    </label>
    <input type="range" class="form-range" id="pitch" name="pitch" min="0.5" max="2.0" step="0.1" value="1.0">
</div>

<!-- Voice Reference -->
<div class="mb-3">
    <label for="voice_reference" class="form-label small fw-bold text-light">
        <i class="fas fa-user-circle"></i> Voix de référence
    </label>
    <input type="file" class="form-control form-control-sm bg-dark text-white border-secondary"
           id="voice_reference" accept="audio/*" name="voice_reference">
    <small class="text-muted d-block mt-1">Audio 6-10s pour clonage</small>
</div>

<!-- Reset Button -->
<button class="btn btn-outline-secondary btn-sm w-100" id="resetOptions">
    <i class="fas fa-undo"></i> Réinitialiser
</button>
{% endblock %}

{% block app_right_panel_actions %}
<div class="d-grid gap-2">
    <button class="btn btn-success btn-sm" id="startAllBtn">
        <i class="fas fa-play"></i> Démarrer
    </button>
    <button class="btn btn-info btn-sm" id="downloadAllBtn">
        <i class="fas fa-download"></i> Télécharger tout
    </button>
    <button class="btn btn-outline-danger btn-sm" id="clearAllBtn">
        <i class="fas fa-trash"></i> Tout effacer
    </button>
</div>
{% endblock %}

{% block synthesizer_content %}

<!-- Upload Zone -->
<div class="row mb-4">
    <div class="col-12">
        <div class="drop-zone" id="dropZone" data-upload-url="{% url 'synthesizer:upload' %}" data-csrf-token="{{ csrf_token }}">
            <i class="fas fa-file-upload fa-3x mb-3 text-primary"></i>
            <h5>Glissez-déposez vos fichiers texte ici</h5>
            <p class="text-light mb-3">ou cliquez pour parcourir</p>
            <p class="small text-white-50">
                Formats supportés: TXT, PDF, DOCX, CSV, MD
            </p>
            <input type="file" id="fileInput" multiple accept=".txt,.pdf,.docx,.csv,.md"
                   style="display: none;">
            <button class="btn btn-primary mt-2" id="browseBtn">
                <i class="fas fa-folder-open"></i> Parcourir
            </button>
        </div>
    </div>
</div>

<!-- Text Input Zone -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: #212529; border: 1px solid #495057;">
            <div class="card-body">
                <h6 class="text-light mb-3">
                    <i class="fas fa-keyboard"></i> Saisir du texte directement
                </h6>
                <form id="textInputForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="textTitle" class="form-label text-light">Titre (optionnel)</label>
                        <input type="text" class="form-control" id="textTitle" name="title"
                               placeholder="Mon texte à synthétiser">
                    </div>
                    <div class="mb-3">
                        <label for="textContent" class="form-label text-light">Texte à synthétiser</label>
                        <textarea class="form-control" id="textContent" name="text_content" rows="5"
                                  placeholder="Entrez votre texte ici..."></textarea>
                        <small class="text-white-50 mt-1 d-block">
                            Le texte sera converti en fichier DOCX et ajouté à la file d'attente
                        </small>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-info" id="previewTextBtn">
                            <i class="fas fa-play-circle"></i> Preview
                        </button>
                        <button type="submit" class="btn btn-success" id="submitTextBtn">
                            <i class="fas fa-plus-circle"></i> Ajouter à la file d'attente
                        </button>
                    </div>
                    <div id="previewAudioContainer" class="mt-3" style="display: none;">
                        <div class="card" style="background: #1a1d20; border: 1px solid #495057;">
                            <div class="card-body">
                                <h6 class="text-light mb-2">
                                    <i class="fas fa-volume-up"></i> Aperçu de la synthèse vocale
                                </h6>
                                <audio id="previewAudioPlayer" controls class="w-100">
                                    <source src="" type="audio/wav">
                                    Votre navigateur ne supporte pas l'élément audio.
                                </audio>
                                <small class="text-white-50 mt-2 d-block">
                                    <i class="fas fa-info-circle"></i> Ceci est un aperçu utilisant les paramètres actuels
                                </small>
                            </div>
                        </div>
                    </div>
                    <div id="previewLoader" class="mt-3" style="display: none;">
                        <div class="card" style="background: #1a1d20; border: 1px solid #495057;">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">Génération en cours...</span>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-white-50">
                                        <i class="fas fa-stream"></i> Génération en streaming...
                                    </small>
                                </div>
                                <div class="progress" style="height: 20px; background: rgba(255,255,255,0.1);">
                                    <div id="previewProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%;">0%</div>
                                </div>
                                <div id="previewStatus" class="mt-2 small text-light text-center">
                                    Préparation...
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Global Progress Bar -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card" style="background: #212529; border: 1px solid #495057;">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-chart-line"></i> Progression globale
                    </h6>
                    <small class="text-white-50" id="globalProgressStats">Calcul...</small>
                </div>
                <div class="progress-bar-custom" style="height: 10px;">
                    <div class="progress-fill" id="globalProgressBar" style="width: 0%"></div>
                </div>
                <div class="text-center mt-1">
                    <small class="text-light" id="globalProgressText">0%</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Syntheses Queue -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-list"></i> File d'attente
            <span class="badge bg-secondary" id="queueCount">{{ syntheses.count }}</span>
        </h4>

        <div id="synthesisQueue">
            {% for synthesis in syntheses %}
            <div class="synthesis-card {% if synthesis.status == 'RUNNING' %}processing{% elif synthesis.status == 'SUCCESS' %}success{% elif synthesis.status == 'FAILURE' %}error{% endif %}"
                 data-id="{{ synthesis.id }}">
                <div class="row align-items-center">
                    <!-- Text File Info -->
                    <div class="col-md-3">
                        <strong>
                            <button type="button" class="btn btn-link p-0 text-start preview-text-btn"
                                    data-id="{{ synthesis.id }}"
                                    style="color: #fff; text-decoration: none;">
                                <i class="fas fa-file-alt"></i> {{ synthesis.filename }}
                            </button>
                        </strong>
                        <br>
                        <small class="text-white-50">
                            {{ synthesis.word_count }} mots •
                            {{ synthesis.duration_display|default:"--:--" }}
                        </small>
                    </div>

                    <!-- Options -->
                    <div class="col-md-2">
                        <small>
                            <i class="fas fa-robot"></i> {{ synthesis.get_tts_model_display|truncatechars:20 }}<br>
                            <i class="fas fa-language"></i> {{ synthesis.get_language_display }}<br>
                            <i class="fas fa-microphone"></i> {{ synthesis.get_voice_preset_display|truncatechars:15 }}
                        </small>
                    </div>

                    <!-- Properties -->
                    <div class="col-md-2">
                        <small class="text-white-50">
                            {{ synthesis.properties|default:"En attente" }}
                        </small>
                    </div>

                    <!-- Status & Progress -->
                    <div class="col-md-2">
                            <span class="badge 
                                {% if synthesis.status == 'PENDING' %}bg-secondary
                                {% elif synthesis.status == 'RUNNING' %}bg-warning
                                {% elif synthesis.status == 'SUCCESS' %}bg-success
                                {% elif synthesis.status == 'FAILURE' %}bg-danger
                                {% endif %}">
                                {{ synthesis.get_status_display }}
                            </span>
                        <div class="progress-bar-custom mt-2">
                            <div class="progress-fill" style="width: {{ synthesis.progress }}%"></div>
                        </div>
                        <small class="text-light">{{ synthesis.progress }}%</small>
                    </div>

                    <!-- Actions -->
                    <div class="col-md-3">
                        <div class="btn-group-actions">
                            {% if synthesis.status != 'RUNNING' %}
                            <button class="btn btn-sm btn-primary start-btn"
                                    data-id="{{ synthesis.id }}"
                                    title="Démarrer">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary settings-btn"
                                    data-id="{{ synthesis.id }}"
                                    data-tts-model="{{ synthesis.tts_model }}"
                                    data-language="{{ synthesis.language }}"
                                    data-voice-preset="{{ synthesis.voice_preset }}"
                                    data-speed="{{ synthesis.speed }}"
                                    data-pitch="{{ synthesis.pitch }}"
                                    title="Paramètres">
                                <i class="fas fa-cog"></i>
                            </button>
                            {% endif %}

                            {% if synthesis.audio_output %}
                            <button class="btn btn-sm btn-success preview-btn"
                                    data-id="{{ synthesis.id }}"
                                    title="Écouter">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <a href="{% url 'synthesizer:download' synthesis.id %}"
                               class="btn btn-sm btn-info"
                               title="Télécharger">
                                <i class="fas fa-download"></i>
                            </a>
                            {% endif %}

                            <button class="btn btn-sm btn-danger delete-btn"
                                    data-id="{{ synthesis.id }}"
                                    title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <!-- Audio Preview (hidden by default) -->
                        <div class="audio-preview mt-2" id="preview_{{ synthesis.id }}"
                             style="display: none;">
                            {% if synthesis.audio_output %}
                            <audio controls class="audio-player">
                                <source src="{{ synthesis.audio_output.url }}" type="audio/wav">
                            </audio>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>Aucun fichier dans la file d'attente</p>
                <p>Uploadez des fichiers texte pour commencer</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_modals %}
<!-- Per-Media Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog"></i> Paramètres de synthèse
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <input type="hidden" id="settingsSynthesisId" name="synthesis_id">

                    <!-- TTS Model -->
                    <div class="mb-3">
                        <label for="settingsTtsModel" class="form-label">
                            <i class="fas fa-robot"></i> Modèle TTS
                        </label>
                        <select class="form-select" id="settingsTtsModel" name="tts_model">
                            {% for value, label in tts_models %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Language -->
                    <div class="mb-3">
                        <label for="settingsLanguage" class="form-label">
                            <i class="fas fa-language"></i> Langue
                        </label>
                        <select class="form-select" id="settingsLanguage" name="language">
                            {% for value, label in languages %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Voice Preset -->
                    <div class="mb-3">
                        <label for="settingsVoicePreset" class="form-label">
                            <i class="fas fa-microphone"></i> Voix
                        </label>
                        <select class="form-select" id="settingsVoicePreset" name="voice_preset">
                            {% for value, label in voice_presets_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Speed -->
                    <div class="mb-3">
                        <label for="settingsSpeed" class="form-label">
                            <i class="fas fa-tachometer-alt"></i> Vitesse: <span id="settingsSpeedValue">1.0</span>x
                        </label>
                        <input type="range" class="form-range" id="settingsSpeed" name="speed"
                               min="0.5" max="2.0" step="0.1" value="1.0"
                               oninput="document.getElementById('settingsSpeedValue').textContent = this.value">
                    </div>

                    <!-- Pitch -->
                    <div class="mb-3">
                        <label for="settingsPitch" class="form-label">
                            <i class="fas fa-wave-square"></i> Hauteur: <span id="settingsPitchValue">1.0</span>x
                        </label>
                        <input type="range" class="form-range" id="settingsPitch" name="pitch"
                               min="0.5" max="2.0" step="0.1" value="1.0"
                               oninput="document.getElementById('settingsPitchValue').textContent = this.value">
                    </div>

                    <!-- Voice Reference -->
                    <div class="mb-3">
                        <label for="settingsVoiceRef" class="form-label">
                            <i class="fas fa-user-circle"></i> Voix de référence (clonage)
                        </label>
                        <input type="file" class="form-control" id="settingsVoiceRef"
                               name="voice_reference" accept="audio/*">
                        <small class="text-muted">Audio 6-10s pour clonage (optionnel)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                    <i class="fas fa-save"></i> Sauvegarder
                </button>
                <button type="button" class="btn btn-success" id="saveAndStartBtn">
                    <i class="fas fa-play"></i> Sauvegarder et démarrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Audio Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-volume-up"></i> Voice Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <audio id="previewAudio" controls class="w-100">
                    <source src="" type="audio/wav">
                </audio>
                <div id="previewInfo" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Text Preview Modal -->
<div class="modal fade" id="textPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textPreviewTitle">
                    <i class="fas fa-file-alt"></i> Prévisualisation du texte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="textPreviewLoader" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2 text-light">Chargement du texte...</p>
                </div>
                <div id="textPreviewContent" style="display: none;">
                    <div class="mb-3">
                        <small class="text-white-50">
                            <i class="fas fa-info-circle"></i>
                            <span id="textPreviewInfo"></span>
                        </small>
                    </div>
                    <div class="card" style="background: #1e1e1e; border: 1px solid #495057;">
                        <div class="card-body">
                            <pre id="textPreviewText" style="color: #d4d4d4; white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.6; margin: 0; max-height: 500px; overflow-y: auto;"></pre>
                        </div>
                    </div>
                </div>
                <div id="textPreviewError" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="textPreviewErrorMsg"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
    // Inject Django URLs and CSRF token into JavaScript
    window.WAMA_CONFIG = {
        urls: {
            upload: "{% url 'synthesizer:upload' %}",
            uploadText: "{% url 'synthesizer:upload_text' %}",
            textPreview: "/synthesizer/text-preview/",
            voicePreview: "/synthesizer/voice-preview/",
            start: "/synthesizer/start/",
            progress: "/synthesizer/progress/",
            globalProgress: "{% url 'synthesizer:global_progress' %}",
            delete: "/synthesizer/delete/",
            startAll: "{% url 'synthesizer:start_all' %}",
            downloadAll: "{% url 'synthesizer:download_all' %}",
            clearAll: "{% url 'synthesizer:clear_all' %}",
            console: "{% url 'synthesizer:console' %}",
            updateOptions: "/synthesizer/update-options/"
        },
        csrfToken: "{{ csrf_token }}"
    };
</script>
<script src="{% static 'synthesizer/js/index.js' %}"></script>
{% endblock %}
