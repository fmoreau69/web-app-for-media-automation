{% extends 'transcriber/base.html' %}
{% load static %}

{% block title %}Transcriber - Speech To Text{% endblock %}

{% block app_right_panel_settings %}
<!-- Backend Selection -->
<div class="mb-3">
    <label class="form-label small fw-bold text-light">
        <i class="fas fa-microchip"></i> Moteur de transcription
    </label>
    <select id="backendSelect" class="form-select form-select-sm">
        <option value="auto" {% if selected_backend == 'auto' %}selected{% endif %}>Auto (meilleur disponible)</option>
        {% for backend in backends %}
        <option value="{{ backend.name }}" {% if selected_backend == backend.name %}selected{% endif %}>
            {{ backend.display_name }}{% if backend.supports_diarization %} (diarisation){% endif %}
        </option>
        {% endfor %}
    </select>
</div>

<!-- Hotwords Input -->
<div class="mb-3">
    <label class="form-label small fw-bold text-light">
        <i class="fas fa-tags"></i> Mots-clés contextuels
    </label>
    <textarea id="hotwordsInput" class="form-control form-control-sm"
              rows="2" placeholder="Noms propres, termes techniques...">{{ user_hotwords }}</textarea>
    <small class="text-muted">Séparés par des virgules</small>
</div>

<!-- Preprocessing Toggle -->
<div class="mb-3">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="preprocessingToggle"
               data-preprocess-url="{% url 'transcriber:set_preprocessing' %}"
               {% if preprocessing_enabled %}checked{% endif %}>
        <label class="form-check-label small fw-bold text-light" for="preprocessingToggle">
            <i class="fas fa-wand-magic-sparkles"></i> Prétraitement audio
        </label>
    </div>
    <small class="d-block mt-1">
        Normalisation + réduction de bruit
    </small>
</div>

<!-- Diarization Toggle (VibeVoice only) -->
<div class="mb-3 vibevoice-option" id="diarizationOption" style="display: none;">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="diarizationToggle" checked>
        <label class="form-check-label small fw-bold text-light" for="diarizationToggle">
            <i class="fas fa-users"></i> Identifier les locuteurs
        </label>
    </div>
</div>

<!-- Info Box -->
<div class="alert alert-info py-2 small" role="alert">
    <i class="fas fa-info-circle"></i> <strong>Moteurs:</strong><br>
    <small>
        • <strong>VibeVoice</strong>: Diarisation, timestamps, 60min max<br>
        • <strong>Whisper</strong>: Rapide, polyvalent
    </small>
</div>

<!-- Info Button -->
<button type="button" class="btn btn-outline-info btn-sm w-100"
        data-bs-toggle="modal" data-bs-target="#preprocessingModal">
    <i class="fas fa-question-circle"></i> En savoir plus
</button>
{% endblock %}

{% block app_right_panel_actions %}
<div class="d-grid gap-2">
    <button id="transcriber-process-btn" class="btn btn-success btn-sm">
        <i class="fas fa-play"></i> Démarrer
    </button>
    <button id="transcriber-download-all-btn" class="btn btn-info btn-sm" disabled>
        <i class="fas fa-download"></i> Télécharger tout
    </button>
    <button id="transcriber-clear-btn" class="btn btn-outline-danger btn-sm">
        <i class="fas fa-trash"></i> Tout effacer
    </button>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
    window.TRANSCRIBER_APP = Object.assign({}, window.TRANSCRIBER_APP, {
      csrfToken: '{{ csrf_token }}',
      uploadUrl: '{% url "transcriber:upload" %}',
      uploadYoutubeUrl: '{% url "transcriber:upload_youtube" %}',
      startUrlTemplate: '{% url "transcriber:start" 0 %}',
      progressUrlTemplate: '{% url "transcriber:progress" 0 %}',
      deleteUrlTemplate: '{% url "transcriber:delete" 0 %}',
      downloadUrlTemplate: '{% url "transcriber:download" 0 %}',
      downloadSrtUrlTemplate: '{% url "transcriber:download_srt" 0 %}',
      segmentsUrlTemplate: '{% url "transcriber:segments" 0 %}',
      settingsUrlTemplate: '{% url "transcriber:save_settings" 0 %}',
      startAllUrl: '{% url "transcriber:start_all" %}',
      clearUrl: '{% url "transcriber:clear_all" %}',
      preprocessingUrl: '{% url "transcriber:set_preprocessing" %}',
      backendsUrl: '{% url "transcriber:backends" %}',
      userSettingsUrl: '{% url "transcriber:get_user_settings" %}',
      saveUserSettingsUrl: '{% url "transcriber:save_user_settings" %}',
      preprocessingEnabled: {{ preprocessing_enabled|yesno:"true,false" }},
    });

    // Show/hide VibeVoice-specific options based on backend selection
    document.addEventListener('DOMContentLoaded', function() {
        const backendSelect = document.getElementById('backendSelect');
        const diarizationOption = document.getElementById('diarizationOption');

        function updateVibeVoiceOptions() {
            if (backendSelect.value === 'vibevoice') {
                diarizationOption.style.display = 'block';
            } else {
                diarizationOption.style.display = 'none';
            }
        }

        if (backendSelect) {
            backendSelect.addEventListener('change', updateVibeVoiceOptions);
            updateVibeVoiceOptions();
        }
    });
</script>
<script src="{% static 'transcriber/js/index.js' %}"></script>
{% endblock %}

{% block transcriber_content %}

<!-- Drag & Drop Zone -->
<div class="row mb-4">
    <div class="col-12">
        <div class="drop-zone" id="dropZoneTranscriber">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
            <h5>Glissez-déposez vos fichiers audio/vidéo ici</h5>
            <p class="text-light mb-3">ou cliquez pour parcourir</p>
            <p class="small text-white-50">
                Audio: MP3, WAV, FLAC, M4A, OGG<br>
                Vidéo: MP4, AVI, MKV, MOV, WEBM
            </p>
            <input type="file" id="transcriber-file" multiple accept="audio/*,video/*" style="display: none;">
            <button class="btn btn-primary mt-2" id="transcriber-browse-btn">
                <i class="fas fa-folder-open"></i> Parcourir
            </button>
        </div>
    </div>
</div>

<!-- YouTube URL Input -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: #212529; border: 1px solid #495057;">
            <div class="card-body">
                <h6 class="text-light mb-3">
                    <i class="fab fa-youtube text-danger"></i> Transcrire depuis YouTube
                </h6>
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           id="youtubeUrl"
                           placeholder="Collez l'URL de la vidéo YouTube ici..."
                           aria-label="YouTube URL">
                    <button class="btn btn-danger" type="button" id="youtubeSubmitBtn">
                        <i class="fas fa-download"></i> Télécharger & Transcrire
                    </button>
                </div>
                <small class="text-white-50 mt-2 d-block">
                    Exemple: https://www.youtube.com/watch?v=dQw4w9WgXcQ
                </small>
            </div>
        </div>
    </div>
</div>

<hr>

<!-- Live Transcription Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="row g-3 align-items-center justify-content-center">
            <div class="col-lg-6 col-12 text-center">
                <button id="transcriber-speak-btn" class="btn btn-warning btn-lg w-100 w-lg-auto">
                    <i class="fas fa-microphone"></i> Speak
                </button>
                <p id="transcriber-speak-hint" class="text small mt-2 mb-0">
                    Lancez une transcription vocale en direct (Chrome recommandé).
                </p>
            </div>
        </div>

        <div class="card bg-dark mt-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="text-light"><i class="fas fa-wave-square"></i> Live transcription</span>
                <small class="text-white" id="live-transcription-status">En attente...</small>
            </div>
            <div class="card-body" style="min-height: 220px;">
                <div id="live-transcription-output" class="text-white" style="text-align: center; font-size: 1.2rem;">
                    Appuyez sur <strong>Speak</strong> puis commencez à parler pour voir le texte apparaître ici en temps réel.
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="border-secondary">

<!-- Global Progress -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-chart-line"></i> Progression globale
                    </h6>
                    <small class="text-white-50" id="globalProgressStats">0/0 terminé</small>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" id="globalProgressBar" role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transcripts Queue -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-list"></i> File d'attente
        </h4>

        <div class="table-responsive">
            <table class="table table-bordered table-dark align-middle" id="transcriber-queue">
                <thead>
                <tr class="text-center">
                    <th style="width: 60px;">ID</th>
                    <th>Audio</th>
                    <th style="width: 120px;">Properties</th>
                    <th style="width: 100px;">Duration</th>
                    <th style="width: 100px;">Status</th>
                    <th style="width: 180px;">Progress</th>
                    <th style="width: 180px;">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for t in transcripts %}
                <tr data-id="{{ t.id }}" data-status="{{ t.status }}" data-preprocess="{{ t.preprocess_audio|yesno:'true,false' }}">
                    <td class="fw-bold text-center">#{{ t.id }}</td>
                    <td>
                        <div class="fw-semibold">{{ t.audio.name|cut:"transcriber/input/" }}</div>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            <a href="{{ t.audio.url }}" target="_blank" class="text-info small">
                                <i class="fas fa-link"></i> Voir le fichier
                            </a>
                            <span class="badge bg-warning text-dark preprocess-badge {% if not t.preprocess_audio %}d-none{% endif %}">
                Prétraité
              </span>
                        </div>
                    </td>
                    <td class="text-center small">{{ t.properties|default:"-" }}</td>
                    <td class="text-center fw-semibold">{{ t.duration_display|default:"--:--" }}</td>
                    <td class="status text-uppercase text-center">{{ t.status }}</td>
                    <td>
                        <div class="progress" style="height: 24px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ t.progress }}%;">
                                {{ t.progress }}%
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a class="btn btn-success btn-sm download-btn {% if not t.text %}disabled{% endif %}"
                               {% if not t.text %}aria-disabled="true" tabindex="-1"{% endif %}
                               href="{% url 'transcriber:download' t.id %}"
                               title="Télécharger TXT">
                                <i class="fas fa-file-alt"></i>
                            </a>
                            <a class="btn btn-info btn-sm download-srt-btn {% if not t.text %}disabled{% endif %}"
                               {% if not t.text %}aria-disabled="true" tabindex="-1"{% endif %}
                               href="{% url 'transcriber:download_srt' t.id %}"
                               title="Télécharger SRT (sous-titres)">
                                <i class="fas fa-closed-captioning"></i>
                            </a>
                            <button class="btn btn-danger btn-sm js-delete-transcript"
                                    data-delete-url="{% url 'transcriber:delete' t.id %}"
                                    title="Supprimer">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr class="empty-row">
                    <td colspan="7" class="text-center py-4">Aucune transcription en attente.</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

<!-- Modal Prétraitement - doit être hors du block transcriber_content pour être au niveau du body -->
{% block extra_modals %}
<div class="modal fade" id="preprocessingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #ffffff !important; color: #000000 !important;">
            <div class="modal-header" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                <h5 class="modal-title" style="color: #000000;">Prétraitement audio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="color: #000000;">
                <h6>Qu'est-ce que le prétraitement audio ?</h6>
                <p>Le prétraitement améliore la qualité de vos enregistrements avant la transcription :</p>
                <ul>
                    <li><strong>Normalisation</strong> : Convertit l'audio en mono 16kHz</li>
                    <li><strong>Réduction de bruit</strong> : Élimine le bruit de fond</li>
                    <li><strong>Ajustement du volume</strong> : Optimise les niveaux sonores</li>
                </ul>

                <h6 class="mt-3">Quand l'utiliser ?</h6>
                <ul>
                    <li>✅ Enregistrements avec du bruit ambiant</li>
                    <li>✅ Audio de mauvaise qualité</li>
                    <li>✅ Enregistrements de réunions ou conférences</li>
                    <li>❌ Studios d'enregistrement professionnels (déjà optimisés)</li>
                </ul>

                <div class="alert alert-info">
                    <i class="fas fa-clock"></i>
                    Le prétraitement ajoute 2-5 secondes par minute d'audio.
                </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
