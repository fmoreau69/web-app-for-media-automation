{% extends 'anonymizer/base.html' %}

{% load static %}

{% block title %}Anonymizer - Objects Blurring{% endblock %}

{% block app_right_panel_settings %}
<!-- CSRF Token for AJAX -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Section: Mode de détection -->
<div class="right-panel-section">
    <div class="right-panel-section-title">
        <i class="fas fa-crosshairs"></i> Mode de détection
    </div>

    <!-- Detection Mode Toggle -->
    <div class="btn-group w-100 mb-2" role="group" aria-label="Detection mode">
        <input type="radio" class="btn-check setting-button" name="detection_mode" id="detection_mode_yolo" value="yolo"
               {% if not gs_values.use_sam3 %}checked{% endif %} autocomplete="off">
        <label class="btn btn-outline-primary btn-sm" for="detection_mode_yolo">
            <i class="fas fa-object-group"></i> YOLO
        </label>
        <input type="radio" class="btn-check setting-button" name="detection_mode" id="detection_mode_sam3" value="sam3"
               {% if gs_values.use_sam3 %}checked{% endif %} autocomplete="off">
        <label class="btn btn-outline-info btn-sm" for="detection_mode_sam3">
            <i class="fas fa-comment-dots"></i> SAM3
        </label>
    </div>

    <!-- SAM3 Status Indicator -->
    <div id="sam3_status_indicator" class="small mb-2" style="display: {% if gs_values.use_sam3 %}block{% else %}none{% endif %};">
        <span class="badge bg-secondary" id="sam3_status_badge">
            <i class="fas fa-spinner fa-spin"></i> Vérification...
        </span>
    </div>
</div>

<!-- Section: Quoi flouter (YOLO) -->
<div class="right-panel-section" id="yolo_settings_section" style="{% if gs_values.use_sam3 %}display: none;{% endif %}">
    <div class="right-panel-section-title">
        <i class="fas fa-eye-slash"></i> Quoi flouter (YOLO)
    </div>

    <!-- Classes Selection Button -->
    <div class="mb-2">
        <button type="button" class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#modal_classes2blur_{{ user.id }}">
            <i class="fas fa-list-check"></i> Sélectionner les classes
        </button>
    </div>

    <!-- Precision Level -->
    <div class="mb-2">
        <div class="d-flex align-items-center gap-2">
            <input class="form-range setting-button" type="range"
                   name="precision_level"
                   id="user_setting_precision_level"
                   value="{% if gs_values.precision_level %}{{ gs_values.precision_level }}{% else %}50{% endif %}"
                   min="0" max="100" step="5"
                   style="flex: 1;"
                   oninput="this.nextElementSibling.textContent = this.value">
            <output class="text-light" style="min-width: 2rem; text-align: center;">{{ gs_values.precision_level|default:"50" }}</output>
            <span class="small text-light">Précision</span>
        </div>
        <div class="text-center">
            <small class="text-info" id="precision_label_rp">
                {% if gs_values.precision_level <= 20 %}Quick
                {% elif gs_values.precision_level <= 40 %}Balanced Quick
                {% elif gs_values.precision_level <= 60 %}Balanced
                {% elif gs_values.precision_level <= 80 %}Balanced Precise
                {% else %}Max Precision{% endif %}
            </small>
        </div>
    </div>

    <!-- Model Selection -->
    <div class="mb-2">
        <select id="user_setting_model_to_use" class="form-select form-select-sm bg-dark text-white border-secondary setting-button">
            <option value="">Auto (basé sur précision)</option>
            {% for model_type, model_list in models_by_type.items %}
                <optgroup label="{{ model_type|title }}">
                    {% for model_name in model_list %}
                        {% if model_type == 'root' %}
                            <option value="{{ model_name }}" {% if gs_values.model_to_use == model_name %}selected{% endif %}>{{ model_name }}</option>
                        {% else %}
                            <option value="{{ model_type }}/{{ model_name }}" {% if gs_values.model_to_use == model_name or gs_values.model_to_use|stringformat:'s' == model_type|add:'/'|add:model_name %}selected{% endif %}>{{ model_name }}</option>
                        {% endif %}
                    {% endfor %}
                </optgroup>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Section: Quoi flouter (SAM3) -->
<div class="right-panel-section" id="sam3_settings_section" style="{% if not gs_values.use_sam3 %}display: none;{% endif %}">
    <div class="right-panel-section-title">
        <i class="fas fa-comment-dots"></i> Quoi flouter (SAM3)
    </div>

    <!-- SAM3 Text Prompt -->
    <div class="mb-2">
        <label class="form-label text-light small mb-1" for="user_setting_sam3_prompt">
            Décrivez ce que vous voulez flouter:
        </label>
        <textarea class="form-control form-control-sm bg-dark text-white border-secondary setting-button"
                  id="user_setting_sam3_prompt"
                  name="sam3_prompt"
                  rows="3"
                  placeholder="Ex: tous les visages et plaques d'immatriculation"
                  maxlength="500">{{ gs_values.sam3_prompt|default:"" }}</textarea>
        <small class="text-white-50 d-flex justify-content-between">
            <span>Prompt pour SAM3</span>
            <span id="sam3_prompt_count">0/500</span>
        </small>
    </div>

    <!-- SAM3 Examples -->
    <div class="mb-2">
        <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="sam3_examples_btn">
            <i class="fas fa-lightbulb"></i> Exemples de prompts
        </button>
    </div>

    <!-- SAM3 Examples Dropdown -->
    <div class="collapse mb-2" id="sam3_examples_collapse">
        <div class="list-group list-group-flush" id="sam3_examples_list">
            <!-- Examples will be loaded dynamically -->
        </div>
    </div>

    <!-- HuggingFace Token Config (if not configured) -->
    <div id="hf_config_warning" class="alert alert-warning py-2 px-3 mb-2" style="display: none;">
        <small>
            <i class="fas fa-exclamation-triangle"></i> Token HuggingFace requis
            <button type="button" class="btn btn-sm btn-warning ms-2" data-bs-toggle="modal" data-bs-target="#modal_hf_config">
                Configurer
            </button>
        </small>
    </div>
</div>

<!-- Section: Comment flouter -->
<div class="right-panel-section">
    <div class="right-panel-section-title">
        <i class="fas fa-adjust"></i> Comment flouter
    </div>

    <!-- Blur Ratio -->
    <div class="mb-2">
        <div class="d-flex align-items-center gap-1">
            <input class="form-range setting-button" type="range"
                   name="blur_ratio"
                   id="user_setting_blur_ratio"
                   value="{{ gs_values.blur_ratio|default:'25' }}"
                   min="1" max="49" step="2"
                   style="flex: 0 0 90px;"
                   oninput="this.nextElementSibling.textContent = this.value">
            <output class="text-light" style="min-width: 2rem; text-align: center;">{{ gs_values.blur_ratio|default:"25" }}</output>
            <span class="small text-light text-nowrap">Intensité flou</span>
        </div>
    </div>

    <!-- ROI Enlargement -->
    <div class="mb-2">
        <div class="d-flex align-items-center gap-1">
            <input class="form-range setting-button" type="range"
                   name="roi_enlargement"
                   id="user_setting_roi_enlargement"
                   value="{{ gs_values.roi_enlargement|default:'1.05' }}"
                   min="0.5" max="1.5" step="0.05"
                   style="flex: 0 0 90px;"
                   oninput="this.nextElementSibling.textContent = this.value">
            <output class="text-light" style="min-width: 2rem; text-align: center;">{{ gs_values.roi_enlargement|default:"1.05" }}</output>
            <span class="small text-light text-nowrap">Agrandissement ROI</span>
        </div>
    </div>

    <!-- Progressive Blur -->
    <div class="mb-2">
        <div class="d-flex align-items-center gap-1">
            <input class="form-range setting-button" type="range"
                   name="progressive_blur"
                   id="user_setting_progressive_blur"
                   value="{{ gs_values.progressive_blur|default:'25' }}"
                   min="3" max="31" step="2"
                   style="flex: 0 0 90px;"
                   oninput="this.nextElementSibling.textContent = this.value">
            <output class="text-light" style="min-width: 2rem; text-align: center;">{{ gs_values.progressive_blur|default:"25" }}</output>
            <span class="small text-light text-nowrap">Flou progressif</span>
        </div>
    </div>

    <!-- Detection Threshold -->
    <div class="mb-2">
        <div class="d-flex align-items-center gap-1">
            <input class="form-range setting-button" type="range"
                   name="detection_threshold"
                   id="user_setting_detection_threshold"
                   value="{{ gs_values.detection_threshold|default:'0.25' }}"
                   min="0" max="1" step="0.05"
                   style="flex: 0 0 90px;"
                   oninput="this.nextElementSibling.textContent = this.value">
            <output class="text-light" style="min-width: 2rem; text-align: center;">{{ gs_values.detection_threshold|default:"0.25" }}</output>
            <span class="small text-light text-nowrap">Seuil détection</span>
        </div>
    </div>
</div>

<!-- Section: Quoi afficher -->
<div class="right-panel-section">
    <div class="right-panel-section-title">
        <i class="fas fa-eye"></i> Quoi afficher
    </div>

    <div class="mb-1">
        <div class="form-check form-switch">
            <input class="form-check-input setting-button" type="checkbox" role="switch"
                   name="show_preview" id="user_setting_show_preview"
                   {% if gs_values.show_preview %}checked{% endif %}>
            <label class="form-check-label text-light small" for="user_setting_show_preview">Prévisualisation</label>
        </div>
    </div>

    <div class="mb-1">
        <div class="form-check form-switch">
            <input class="form-check-input setting-button" type="checkbox" role="switch"
                   name="show_boxes" id="user_setting_show_boxes"
                   {% if gs_values.show_boxes %}checked{% endif %}>
            <label class="form-check-label text-light small" for="user_setting_show_boxes">Boîtes de détection</label>
        </div>
    </div>

    <div class="mb-1">
        <div class="form-check form-switch">
            <input class="form-check-input setting-button" type="checkbox" role="switch"
                   name="show_labels" id="user_setting_show_labels"
                   {% if gs_values.show_labels %}checked{% endif %}>
            <label class="form-check-label text-light small" for="user_setting_show_labels">Labels</label>
        </div>
    </div>

    <div class="mb-1">
        <div class="form-check form-switch">
            <input class="form-check-input setting-button" type="checkbox" role="switch"
                   name="show_conf" id="user_setting_show_conf"
                   {% if gs_values.show_conf %}checked{% endif %}>
            <label class="form-check-label text-light small" for="user_setting_show_conf">Confiance</label>
        </div>
    </div>
</div>

<!-- Reset Button -->
<form method="post" action="{% url 'anonymizer:reset_user_settings' %}" class="mt-2">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.path }}">
    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
        <i class="fas fa-rotate-left"></i> Reset paramètres
    </button>
</form>

{% endblock %}

{% block app_right_panel_actions %}
<div class="d-grid gap-2">
    <button id="process-toggle-btn" class="btn btn-success btn-sm">
        <i class="fas fa-play"></i> Démarrer
    </button>
    <form action="{% url 'anonymizer:download_all_media' %}" method="post" class="d-grid">
        {% csrf_token %}
        <button id="download-all-btn" type="submit" class="btn btn-info btn-sm" disabled>
            <i class="fas fa-download"></i> Télécharger tout
        </button>
    </form>
    <button type="button" id="clear_all_media_btn" class="btn btn-outline-danger btn-sm">
        <i class="fas fa-trash"></i> Tout effacer
    </button>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
{# JQUERY FILE UPLOAD SCRIPTS #}
<script src="{% static 'js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
<script src="{% static 'js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>
<script src="{% static 'js/jquery-file-upload/jquery.fileupload.js' %}"></script>

{# MEDIAS PAGE SCRIPTS #}
<script src="{% static 'common/js/console.js' %}"></script>
<script src="{% static 'anonymizer/js/process.js' %}"></script>
<script src="{% static 'anonymizer/js/update.js' %}"></script>
<script src="{% static 'anonymizer/js/upload.js' %}"></script>
<script src="{% static 'anonymizer/js/settings_modal.js' %}"></script>
<script src="{% static 'anonymizer/js/right_panel.js' %}"></script>
{% endblock %}

{% block anonymizer_content %}

<!-- Upload Zone -->
<div class="row mb-4">
    <div class="col-12">
        <div class="drop-zone" id="dropZoneAnonymizer">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
            <h5 class="text-light">Glissez-déposez vos fichiers photo/vidéo ici</h5>
            <p class="text-light mb-3">ou cliquez pour parcourir</p>
            <p class="small text-white-50">
                Photo: JPG, PNG, GIF, BMP, WEBP<br>
                Vidéo: MP4, AVI, MKV, MOV, WEBM
            </p>
            <input id="fileupload" type="file" name="file" multiple
                   accept="image/*,video/*"
                   style="display: none;"
                   data-url="{% url 'anonymizer:upload' %}"
                   data-form-data='{"csrfmiddlewaretoken": "{{ csrf_token }}"}'>
            <button type="button" class="btn btn-primary mt-2 js-upload-medias">
                <i class="fas fa-folder-open"></i> Parcourir
            </button>
        </div>
    </div>
</div>

<!-- URL Upload Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h6 class="text-light mb-3">
                    <i class="fas fa-link"></i> Télécharger depuis une URL
                </h6>
                <form id="media-url-form" method="post" enctype="multipart/form-data" action="{% url 'anonymizer:upload' %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text"
                               class="form-control bg-dark text-white border-secondary"
                               id="media_url"
                               name="media_url"
                               placeholder="Collez l'URL de la photo/vidéo ici..."
                               aria-label="Media URL">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                    </div>
                    <small class="text-white-50 mt-2 d-block">
                        Exemple: https://example.com/video.mp4 ou lien YouTube
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<hr class="border-secondary">

<!-- Main Content Container -->
<div id="main_container">
    {% include "anonymizer/upload/content.html" %}
</div>
{% endblock %}

{% block extra_modals %}
<!-- Classes Selection Modal -->
<div class="modal fade" id="modal_classes2blur_{{ user.id }}" tabindex="-1" aria-labelledby="modalClasses2blurLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalClasses2blurLabel">
                    <i class="fas fa-list-check me-2"></i>Sélectionner les classes à flouter
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="mb-3">
                    <strong class="text-info">Classes spéciales</strong>
                    <div class="row mt-2">
                        {% for cls in classes %}
                            {% if cls.0 == 'face' or cls.0 == 'plate' %}
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input classes2blur-checkbox" type="checkbox"
                                           name="classes2blur" value="{{ cls.0 }}"
                                           id="classes2blur_global_{{ cls.0 }}"
                                           {% if cls.0 in gs_values.classes2blur %}checked{% endif %}>
                                    <label class="form-check-label text-light" for="classes2blur_global_{{ cls.0 }}">
                                        {{ cls.1 }}
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <hr class="border-secondary">
                <div class="mb-3">
                    <strong class="text-info">Classes COCO (objets courants)</strong>
                    <div class="row mt-2">
                        {% for cls in classes %}
                            {% if cls.0 != 'face' and cls.0 != 'plate' %}
                            <div class="col-md-4 col-sm-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input classes2blur-checkbox" type="checkbox"
                                           name="classes2blur" value="{{ cls.0 }}"
                                           id="classes2blur_global_{{ cls.0 }}"
                                           {% if cls.0 in gs_values.classes2blur %}checked{% endif %}>
                                    <label class="form-check-label text-light small" for="classes2blur_global_{{ cls.0 }}">
                                        {{ cls.1 }}
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <span class="text-white-50 me-auto" id="classes2blur_count">0 classe(s) sélectionnée(s)</span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!--  Progress popup - Must be at body level for proper z-index -->
<div class="modal fade" id="modal-progress" tabindex="-1" aria-labelledby="modalProgressLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-white" id="modalProgressLabel">
                    <i class="fas fa-upload me-2"></i>Téléchargement en cours...
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="progress" style="height: 24px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width: 0%;"
                         aria-valuenow="0"
                         aria-valuemin="0"
                         aria-valuemax="100">0%</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- HuggingFace Token Configuration Modal -->
<div class="modal fade" id="modal_hf_config" tabindex="-1" aria-labelledby="modalHfConfigLabel">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalHfConfigLabel">
                    <i class="fas fa-key me-2"></i>Configuration HuggingFace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="small text-white-50">
                    SAM3 nécessite un token HuggingFace pour télécharger les modèles.
                    Obtenez votre token sur <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-info">huggingface.co/settings/tokens</a>
                </p>
                <div class="mb-3">
                    <label for="hf_token_input" class="form-label">Token HuggingFace</label>
                    <input type="password" class="form-control bg-dark text-white border-secondary"
                           id="hf_token_input" placeholder="hf_xxxxxxxxxxxxx">
                    <div class="form-text text-white-50">Le token commence par "hf_"</div>
                </div>
                <div id="hf_config_result" class="alert d-none" role="alert"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="hf_config_save_btn">
                    <i class="fas fa-save me-1"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
