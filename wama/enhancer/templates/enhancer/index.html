{% extends 'enhancer/base.html' %}
{% load static %}

{% block title %}Enhancer - AI Image/Video Upscaling{% endblock %}

{% block app_right_panel_settings %}
<!-- AI Model Selection -->
<div class="mb-3">
    <label for="defaultAiModel" class="form-label small fw-bold text-light">
        <i class="fas fa-brain"></i> Modèle AI
    </label>
    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="defaultAiModel">
        {% for value, label in ai_models %}
        <option value="{{ value }}" {% if user_settings.default_ai_model == value %}selected{% endif %}>
            {{ label }}
        </option>
        {% endfor %}
    </select>
</div>

<!-- Denoise Option -->
<div class="mb-3">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="defaultDenoise"
               {% if user_settings.default_denoise %}checked{% endif %}>
        <label class="form-check-label small text-light" for="defaultDenoise">
            <i class="fas fa-broom"></i> Débruitage
        </label>
    </div>
    <small class="d-block">Appliquer avant upscaling</small>
</div>

<!-- Blend Factor -->
<div class="mb-3">
    <label for="defaultBlendFactor" class="form-label small fw-bold text-light">
        <i class="fas fa-sliders-h"></i> Blend: <span id="blendValue">{{ user_settings.default_blend_factor }}</span>
    </label>
    <input type="range" class="form-range" id="defaultBlendFactor"
           min="0" max="1" step="0.1" value="{{ user_settings.default_blend_factor }}"
           oninput="document.getElementById('blendValue').textContent = this.value">
    <div class="d-flex justify-content-between">
        <small>100% AI</small>
        <small>100% Original</small>
    </div>
</div>

<!-- Model Info -->
<div class="alert alert-info py-2 small" role="alert">
    <i class="fas fa-info-circle"></i> <strong>Modèles:</strong><br>
    <small>
        • <strong>RealESR_Gx4</strong>: Rapide (4x)<br>
        • <strong>BSRGANx2/x4</strong>: Haute qualité<br>
        • <strong>RealESRGANx4</strong>: Max qualité<br>
        • <strong>IRCNN</strong>: Débruitage (1x)
    </small>
</div>
{% endblock %}

{% block app_right_panel_actions %}
<div class="d-grid gap-2">
    <button id="enhancer-process-btn" class="btn btn-success btn-sm">
        <i class="fas fa-play"></i> Démarrer
    </button>
    <button id="enhancer-download-all-btn" class="btn btn-info btn-sm" disabled>
        <i class="fas fa-download"></i> Télécharger tout
    </button>
    <button id="enhancer-clear-btn" class="btn btn-outline-danger btn-sm">
        <i class="fas fa-trash"></i> Tout effacer
    </button>
</div>
{% endblock %}

{% block enhancer_content %}
<!-- Drag & Drop Zone -->
<div class="row mb-4">
    <div class="col-12">
        <div class="drop-zone" id="dropZoneEnhancer">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
            <h5>Glissez-déposez vos fichiers ici</h5>
            <p class="text-light mb-3">ou cliquez pour parcourir</p>
            <p class="small text-white-50">
                Images: JPG, PNG, BMP, TIF, WebP, HEIC<br>
                Vidéos: MP4, WebM, MKV, AVI, MOV, GIF
            </p>
            <input type="file" id="enhancer-file" multiple accept="image/*,video/*" style="display: none;">
            <button class="btn btn-primary mt-2" id="enhancer-browse-btn">
                <i class="fas fa-folder-open"></i> Parcourir
            </button>
        </div>
    </div>
</div>

<!-- URL Upload Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body">
                <h6 class="text-light mb-3">
                    <i class="fas fa-link"></i> Télécharger depuis une URL
                </h6>
                <form id="media-url-form" method="post" enctype="multipart/form-data" action="{% url 'enhancer:upload' %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text"
                               class="form-control bg-dark text-white border-secondary"
                               id="media_url"
                               name="media_url"
                               placeholder="Collez l'URL du média ici..."
                               aria-label="Media URL">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                    </div>
                    <small class="text-white-50 mt-2 d-block">
                        Exemple: https://example.com/video.mp4 ou lien YouTube
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<hr class="border-secondary">

<!-- Global Progress -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 text-light">
                        <i class="fas fa-chart-line"></i> Progression globale
                    </h6>
                    <small class="text-white-50" id="globalProgressStats">0/0 terminé</small>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" id="globalProgressBar" role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhancements Queue -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-list"></i> File d'attente
        </h4>

        <div class="table-responsive">
            <table class="table table-bordered table-dark align-middle" id="enhancer-queue">
                <thead>
                <tr class="text-center">
                    <th style="width: 80px;">ID</th>
                    <th style="width: 100px;">Type</th>
                    <th>Fichier</th>
                    <th style="width: 150px;">Dimensions</th>
                    <th style="width: 150px;">Modèle AI</th>
                    <th style="width: 120px;">Statut</th>
                    <th style="width: 220px;">Progression</th>
                    <th style="width: 160px;">Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for e in enhancements %}
                <tr data-id="{{ e.id }}" data-status="{{ e.status }}">
                    <td class="fw-bold text-center">#{{ e.id }}</td>
                    <td class="text-center">
                        {% if e.media_type == 'image' %}
                        <i class="fas fa-image text-info"></i> Image
                        {% else %}
                        <i class="fas fa-video text-warning"></i> Vidéo
                        {% endif %}
                    </td>
                    <td>
                        <div class="fw-semibold">
                            <button type="button" class="btn btn-link p-0 text-decoration-none preview-media-link"
                                    data-preview-url="{% url 'common:unified_preview' 'enhancer' e.id %}"
                                    style="color: inherit;">
                                {{ e.get_input_filename }}
                            </button>
                        </div>
                        <div class="d-flex align-items-center gap-2 mt-1">
                            {% if e.denoise %}
                            <span class="badge bg-primary">Débruitage</span>
                            {% endif %}
                            {% if e.blend_factor > 0 %}
                            <span class="badge bg-secondary">Blend {{ e.blend_factor }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="text-center small">
                        {{ e.width }}x{{ e.height }}
                        {% if e.output_width %}
                        <br><i class="fas fa-arrow-right text-success"></i> {{ e.output_width }}x{{ e.output_height }}
                        {% endif %}
                    </td>
                    <td class="text-center small">
                        <span class="badge bg-info">{{ e.get_ai_model_display }}</span>
                    </td>
                    <td class="status text-uppercase text-center">{{ e.status }}</td>
                    <td>
                        <div class="progress" style="height: 24px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ e.progress }}%;">
                                {{ e.progress }}%
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary btn-sm js-restart-enhancement"
                                    data-id="{{ e.id }}"
                                    title="Relancer le traitement">
                                <i class="fas fa-play"></i>
                            </button>
                            <a class="btn btn-success btn-sm download-btn {% if not e.output_file %}disabled{% endif %}"
                               {% if not e.output_file %}aria-disabled="true" tabindex="-1"{% endif %}
                               href="{% url 'enhancer:download' e.id %}">
                                <i class="fas fa-download"></i>
                            </a>
                            <button class="btn btn-warning btn-sm js-open-settings"
                                    data-id="{{ e.id }}"
                                    data-ai-model="{{ e.ai_model }}"
                                    data-denoise="{{ e.denoise|lower }}"
                                    data-blend-factor="{{ e.blend_factor }}"
                                    title="Configurer les paramètres">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="btn btn-danger btn-sm js-delete-enhancement"
                                    data-delete-url="{% url 'enhancer:delete' e.id %}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr class="empty-row">
                    <td colspan="8" class="text-center py-4">Aucun fichier en attente.</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock enhancer_content %}

{% block app_scripts %}
<script>
    window.ENHANCER_APP = Object.assign({}, window.ENHANCER_APP, {
      csrfToken: '{{ csrf_token }}',
      uploadUrl: '{% url "enhancer:upload" %}',
      startUrlTemplate: '{% url "enhancer:start" 0 %}',
      progressUrlTemplate: '{% url "enhancer:progress" 0 %}',
      deleteUrlTemplate: '{% url "enhancer:delete" 0 %}',
      downloadUrlTemplate: '{% url "enhancer:download" 0 %}',
      updateSettingsUrlTemplate: '{% url "enhancer:update_settings" 0 %}',
      startAllUrl: '{% url "enhancer:start_all" %}',
      clearUrl: '{% url "enhancer:clear_all" %}',
      downloadAllUrl: '{% url "enhancer:download_all" %}',
      globalProgressUrl: '{% url "enhancer:global_progress" %}',
    });
</script>
<script src="{% static 'enhancer/js/index.js' %}"></script>
<script src="{% static 'common/js/media-preview.js' %}"></script>
{% endblock %}
