{% extends 'base.html' %}

{% block javascript %}
{{ block.super }}
<script>
  // Si l'URL contient un paramètre "next", afficher automatiquement le modal de login
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('next')) {
      const loginModal = document.getElementById('LOGIN-MODAL');
      if (loginModal) {
        const modal = new bootstrap.Modal(loginModal);
        modal.show();
      }
    }

    // AI Chat functionality (Admin only)
    const chatForm = document.getElementById('ai-chat-form');
    if (chatForm) {
      const chatInput = document.getElementById('ai-chat-input');
      const chatMessages = document.getElementById('ai-chat-messages');
      const chatSubmit = document.getElementById('ai-chat-submit');
      const providerSelect = document.getElementById('ai-provider');
      const modelSelect = document.getElementById('ai-model');
      const modelContainer = document.getElementById('model-container');

      // Show/hide model selector based on provider
      function updateModelVisibility() {
        if (providerSelect.value === 'wama-dev-ai') {
          modelContainer.style.display = 'block';
        } else {
          modelContainer.style.display = 'none';
        }
      }

      providerSelect.addEventListener('change', updateModelVisibility);
      updateModelVisibility();

      function addMessage(content, isUser = false, isError = false, modelInfo = null) {
        // Clear placeholder if exists
        const placeholder = chatMessages.querySelector('.text-center');
        if (placeholder) placeholder.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${isUser ? 'text-end' : ''}`;

        const bubble = document.createElement('div');
        bubble.className = `d-inline-block p-3 rounded-3 ${isUser ? 'bg-primary text-white' : isError ? 'bg-danger text-white' : 'bg-secondary text-white'}`;
        bubble.style.maxWidth = '85%';
        bubble.style.textAlign = 'left';
        bubble.style.whiteSpace = 'pre-wrap';
        bubble.style.wordBreak = 'break-word';
        bubble.textContent = content;

        // Add model info badge for assistant messages
        if (!isUser && !isError && modelInfo) {
          const modelBadge = document.createElement('div');
          modelBadge.className = 'small mt-1';
          modelBadge.textContent = modelInfo;
          bubble.appendChild(modelBadge);
        }

        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addLoadingIndicator() {
        const placeholder = chatMessages.querySelector('.text-muted.text-center');
        if (placeholder) placeholder.remove();

        const provider = providerSelect.value;
        const providerName = provider === 'claude' ? 'Claude' : 'wama-dev-ai';

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'ai-loading';
        loadingDiv.className = 'mb-3';
        loadingDiv.innerHTML = `
          <div class="d-inline-block p-3 rounded-3 bg-secondary text-white">
            <i class="fas fa-spinner fa-spin me-2"></i> ${providerName} is thinking...
          </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeLoadingIndicator() {
        const loading = document.getElementById('ai-loading');
        if (loading) loading.remove();
      }

      chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, true);
        chatInput.value = '';

        // Disable input while processing
        chatInput.disabled = true;
        chatSubmit.disabled = true;
        chatSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // Show loading indicator
        addLoadingIndicator();

        // Build request body
        const requestBody = {
          message: message,
          provider: providerSelect.value
        };

        // Add model if using wama-dev-ai
        if (providerSelect.value === 'wama-dev-ai') {
          requestBody.model = modelSelect.value;
        }

        try {
          const response = await fetch('/api/ai-chat/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(requestBody)
          });

          removeLoadingIndicator();

          const data = await response.json();

          if (data.success) {
            addMessage(data.response, false, false, data.model);
          } else {
            addMessage(data.error || 'An error occurred', false, true);
          }
        } catch (error) {
          removeLoadingIndicator();
          addMessage('Network error: ' + error.message, false, true);
        } finally {
          // Re-enable input
          chatInput.disabled = false;
          chatSubmit.disabled = false;
          chatSubmit.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
          chatInput.focus();
        }
      });
    }
  });
</script>
{% endblock %}

{% block content %}
<div class="home-wrapper">
  <div class="container-fluid py-4" style="max-width: 1200px;">

    <div class="row mb-4">
      <div class="col-12">
        <h1 class="page-header mb-3">
          <i class="fas fa-robot"></i> WAMA: Web App for Media Automation
        </h1>
        <p class="lead">
          WAMA is a web application developed at Lescot and based on deep learning, offering AI tools applied to media.
        </p>
      </div>
    </div>

    {% if is_admin %}
    <hr>

    <!-- AI Chat (Admin Only) -->
    <div class="row mb-4">
      <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-comments"></i> AI Assistant <span class="badge bg-secondary">Admin</span></h4>
        <div class="card" style="background: #212529; border: 1px solid #495057;">
          <div class="card-body">
            <!-- Provider Selection -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label small">Provider</label>
                <select id="ai-provider" class="form-select form-select-sm" style="background: #1a1d21; border: 1px solid #495057; color: #fff;">
                  <option value="wama-dev-ai" selected>wama-dev-ai (Local/Ollama)</option>
                  <option value="claude">Claude (Anthropic API)</option>
                </select>
              </div>
              <div class="col-md-6" id="model-container">
                <label class="form-label small">Model</label>
                <select id="ai-model" class="form-select form-select-sm" style="background: #1a1d21; border: 1px solid #495057; color: #fff;">
                  <option value="fast" selected>Qwen3 14B (Fast)</option>
                  <option value="ultra_fast">Qwen3 8B (Ultra Fast)</option>
                  <option value="dev">Qwen3 30B (Dev)</option>
                  <option value="coder">Qwen3 Coder 30B</option>
                  <option value="architect">Qwen3 30B Thinking</option>
                </select>
              </div>
            </div>
            <!-- Chat Messages Container -->
            <div id="ai-chat-messages" class="mb-3" style="max-height: 400px; overflow-y: auto; min-height: 100px; background: #1a1d21; border-radius: 8px; padding: 15px;">
              <div class="text-center py-4">
                <i class="fas fa-robot fa-2x mb-2"></i>
                <p class="mb-0">Ask me anything about WAMA or get help with tasks.</p>
                <p class="small mt-2">Using local AI by default (wama-dev-ai)</p>
              </div>
            </div>
            <!-- Input Form -->
            <form id="ai-chat-form" class="d-flex gap-2">
              <input type="text" id="ai-chat-input" class="form-control" placeholder="Type your message..." autocomplete="off" style="background: #1a1d21; border: 1px solid #495057; color: #fff;">
              <button type="submit" id="ai-chat-submit" class="btn btn-primary" style="min-width: 100px;">
                <i class="fas fa-paper-plane"></i> Send
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <hr>

    <!-- Applications génériques -->
    <div class="row mb-4">
      <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-tools"></i> WAMA App</h4>
<!--        <p class="mb-2" style="font-size: 0.9em;">
          Applications génériques
        </p>-->
        <div class="row g-3">

          <!-- Anonymizer -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-user-secret text-danger"></i> Anonymizer
                </h5>
                <p class="card-text text-light flex-grow-1">
                  Automatic blurring of objects in photos/videos
                </p>
                <a href="{% url 'anonymizer:index' %}" class="btn btn-danger mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

          <!-- Describer -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-search-plus text-info"></i> Describer
                </h5>
                <p class="card-text text-light flex-grow-1">
                  AI-powered content description and summarization
                </p>
                <a href="{% url 'describer:index' %}" class="btn btn-info mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

          <!-- Enhancer -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-magic text-info"></i> Enhancer
                </h5>
                <p class="card-text text-light flex-grow-1">
                  AI-powered image/video upscaling and quality enhancement
                </p>
                <a href="{% url 'enhancer:index' %}" class="btn btn-info mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

          <!-- Imager -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-image text-success"></i> Imager
                </h5>
                <p class="card-text text-light flex-grow-1">
                  AI-powered image generation from text descriptions
                </p>
                <a href="{% url 'imager:index' %}" class="btn btn-success mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

          <!-- Synthesizer -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-microphone text-primary"></i> Synthesizer
                </h5>
                <p class="card-text text-light flex-grow-1">
                  Automatic voice synthesis from text files
                </p>
                <a href="{% url 'synthesizer:index' %}" class="btn btn-primary mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

          <!-- Transcriber -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-file-alt text-warning"></i> Transcriber
                </h5>
                <p class="card-text text-light flex-grow-1">
                  Automatic transcription of audio files into text
                </p>
                <a href="{% url 'transcriber:index' %}" class="btn btn-warning mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <hr>

    <!-- Applications WAMA Lab -->
    <div class="row mb-4">
      <div class="col-12">
        <h4 class="mb-3">
          <i class="fas fa-flask"></i> WAMA Lab 
          <span class="badge bg-secondary ms-2">Research</span>
        </h4>
<!--        <p class="mb-3" style="font-size: 0.9em;">
          Applications expérimentales développées pour la recherche
        </p>-->
        <div class="row g-3">

          <!-- Face Analyzer -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="background: #212529; border: 1px solid #495057;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title text-light">
                  <i class="fas fa-smile text-info"></i> Face Analyzer
                </h5>
                <p class="card-text text-light flex-grow-1">
                  Non-invasive physiological signal analysis from facial video: heart rate, HRV, eye tracking, emotions, respiration
                </p>
                <a href="{% url 'wama_lab:face_analyzer:index' %}" class="btn btn-info mt-auto">
                  <i class="fas fa-arrow-right"></i> Open
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <hr>

    <!-- Applications à venir -->
    <div class="row mb-4">
      <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-clock"></i> Upcoming Features</h4>
        <div class="card" style="background: #212529; border: 1px solid #495057;">
          <div class="card-body">
            <ul class="text-light mb-0">
              <li><strong>More features coming soon...</strong> Stay tuned!</li>
            </ul>
            <p class="text-light mt-3 mb-0">
              <i class="fab fa-github"></i> See the
              <a href="https://github.com/fmoreau69/web-app-for-media-automation" target="_blank" class="text-info">
                GitHub project
              </a> for more details
            </p>
          </div>
        </div>
      </div>
    </div>

    {% if user.username == 'anonymous' or not user.is_authenticated %}
    <hr>

    <!-- Login prompt -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-info" style="background: #1a3a52; border: 1px solid #2980b9;">
          <h5 class="alert-heading">
            <i class="fas fa-door-open"></i> Get Started
          </h5>
          <p class="mb-0">
            To access all features and save your work, please
            <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#LOGIN-MODAL">
              log in to WAMA
            </a>
          </p>
        </div>
      </div>
    </div>
    {% endif %}

    <hr>

    <!-- WAMA Presentation -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
          <div class="card-body text-center py-4">
            <h4 class="text-white mb-3">
              <i class="fas fa-presentation"></i> Découvrir WAMA
            </h4>
            <p class="text-white-50 mb-3">
              Présentation interactive de la plateforme WAMA et de ses fonctionnalités
            </p>
            <a href="{% url 'presentation' %}" class="btn btn-light btn-lg">
              <i class="fas fa-play-circle"></i> Lancer la présentation
            </a>
          </div>
        </div>
      </div>
    </div>

<!--    <hr>-->

    <!-- Demo video -->
<!--    <div class="row mb-4">
      <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-video"></i> Anonymizer Demo</h4>
        <div class="card" style="background: #212529; border: 1px solid #495057;">
          <div class="card-body">
            <div class="ratio ratio-16x9">
              <iframe
                src="https://www.youtube.com/embed/243buD-70FI"
                style="border-radius: 8px;"
                allowfullscreen>
              </iframe>
            </div>
          </div>
        </div>
      </div>
    </div>-->

  </div>
</div>
{% endblock %}
