<!DOCTYPE html>
{% load static %}
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}WAMA{% endblock %}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link href="{% static 'css/general_index.css' %}" rel="stylesheet">
    <link href="{% static 'common/css/app_modern.css' %}" rel="stylesheet">
    <link href="{% static 'common/css/media-preview.css' %}" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="{% static 'images/favicon.png' %}" >

    <!-- jstree CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/themes/default-dark/style.min.css" rel="stylesheet">
    <!-- FileManager CSS -->
    <link href="{% static 'filemanager/css/filemanager.css' %}" rel="stylesheet">

    {% block extra_css %}{% endblock %}
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    {% block top_navigation %}
      <div class="top_nav">
        {% include 'includes/header.html' %}
      </div>
    {% if messages %}
      <ul class="messages">
        {% for message in messages %}
          <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>
            {{ message }}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    {% endblock top_navigation %}
    <div class="container">
      {% block content %}
      {% endblock %}
    </div>

    {# Footer - au niveau du body pour pleine largeur #}
    {% block footer %}
    <footer class="bg-black text-white-50 py-2 border-top border-secondary">
        <div class="container-fluid px-3 position-relative">
            <div class="d-flex justify-content-center align-items-center">
                <!-- Center: App name -->
                <small class="text-white">
                    {% block footer_text %}
                    WAMA - Web App for Media Automation
                    {% endblock %}
                </small>
            </div>

            <!-- Right: System Stats (absolute positioned) -->
            <div id="systemStats" class="d-flex align-items-center gap-3 position-absolute end-0 top-50 translate-middle-y me-3" style="font-size: 0.75rem;">
                <!-- CPU -->
                <div class="d-flex align-items-center gap-1" title="CPU">
                    <i class="fas fa-microchip text-info" style="width: 14px;"></i>
                    <div class="progress bg-dark" style="width: 50px; height: 6px;">
                        <div id="cpuBar" class="progress-bar bg-info" style="width: 0%;"></div>
                    </div>
                    <span id="cpuText" style="min-width: 32px;">--%</span>
                </div>

                <!-- RAM -->
                <div class="d-flex align-items-center gap-1" title="RAM">
                    <i class="fas fa-memory text-success" style="width: 14px;"></i>
                    <div class="progress bg-dark" style="width: 50px; height: 6px;">
                        <div id="ramBar" class="progress-bar bg-success" style="width: 0%;"></div>
                    </div>
                    <span id="ramText" style="min-width: 32px;">--%</span>
                </div>

                <!-- GPU (hidden if not available) -->
                <div id="gpuStats" class="d-flex align-items-center gap-1" style="display: none !important;" title="GPU">
                    <i class="fas fa-tv text-warning" style="width: 14px;"></i>
                    <div class="progress bg-dark" style="width: 50px; height: 6px;">
                        <div id="gpuBar" class="progress-bar bg-warning" style="width: 0%;"></div>
                    </div>
                    <span id="gpuText" style="min-width: 32px;">--%</span>
                </div>

                <!-- Disk -->
                <div class="d-flex align-items-center gap-1" title="Disque">
                    <i class="fas fa-hdd text-secondary" style="width: 14px;"></i>
                    <span id="diskText" style="min-width: 32px;">--%</span>
                </div>
            </div>
        </div>
    </footer>
    {% endblock %}

    {# Modal login - doit être directement dans le body pour Bootstrap 5 #}
    {% include 'accounts/login_modal.html' %}

    {# FileManager Sidebar (left) #}
    {% include 'filemanager/sidebar.html' %}

    {# WAMA Right Panel (settings & preview) #}
    <aside id="wama-right-panel">
        <!-- Header -->
        <div class="right-panel-header">
            <h5><i class="fas fa-sliders-h me-2"></i>Panneau</h5>
        </div>

        <!-- Content -->
        <div class="right-panel-content">
            <!-- Preview Section -->
            <div class="right-panel-section" id="preview-section">
                <div class="right-panel-section-title">
                    <i class="fas fa-eye me-1"></i> Aperçu
                </div>
                <div class="right-panel-preview" id="preview-container">
                    <div class="right-panel-preview-placeholder" id="preview-placeholder">
                        <i class="fas fa-photo-video"></i>
                        <p>Sélectionnez un fichier<br>pour l'aperçu</p>
                    </div>
                    <div id="preview-media" style="display: none;">
                        <!-- Dynamic preview content -->
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="right-panel-section" id="settings-section">
                <div class="right-panel-section-title">
                    <i class="fas fa-cog me-1"></i> Paramètres
                </div>
                <div id="global-settings-container">
                    {% block right_panel_settings %}
                    <p class="small">Aucun paramètre disponible</p>
                    {% endblock %}
                </div>
            </div>

            <!-- Actions Section -->
            <div class="right-panel-section" id="actions-section">
                <div class="right-panel-section-title">
                    <i class="fas fa-play-circle me-1"></i> Actions
                </div>
                <div id="global-actions-container">
                    {% block right_panel_actions %}
                    <!-- Actions will be added by apps -->
                    {% endblock %}
                </div>
            </div>
        </div>
    </aside>

    <!-- Right Panel Script -->
    <script>
        window.WAMA_RIGHT_PANEL = {
            showPreview: function(url, type) {
                const placeholder = document.getElementById('preview-placeholder');
                const mediaContainer = document.getElementById('preview-media');

                if (!url) {
                    placeholder.style.display = 'block';
                    mediaContainer.style.display = 'none';
                    mediaContainer.innerHTML = '';
                    return;
                }

                placeholder.style.display = 'none';
                mediaContainer.style.display = 'block';

                if (type === 'video' || url.match(/\.(mp4|webm|ogg|mov|avi)$/i)) {
                    mediaContainer.innerHTML = `
                        <video controls autoplay muted style="width: 100%; border-radius: 4px;">
                            <source src="${url}" type="video/mp4">
                        </video>
                    `;
                } else if (type === 'image' || url.match(/\.(jpg|jpeg|png|gif|webp|bmp)$/i)) {
                    mediaContainer.innerHTML = `
                        <img src="${url}" alt="Preview" style="width: 100%; border-radius: 4px;">
                    `;
                } else if (type === 'audio' || url.match(/\.(mp3|wav|ogg|flac|m4a)$/i)) {
                    mediaContainer.innerHTML = `
                        <audio controls style="width: 100%;">
                            <source src="${url}">
                        </audio>
                    `;
                } else {
                    mediaContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-file fa-2x mb-2"></i>
                            <p class="small mb-0">Aperçu non disponible</p>
                        </div>
                    `;
                }
            },
            clearPreview: function() {
                this.showPreview(null);
            },
            updateSettings: function(html) {
                const container = document.getElementById('global-settings-container');
                if (container) container.innerHTML = html;
            },
            updateActions: function(html) {
                const container = document.getElementById('global-actions-container');
                if (container) container.innerHTML = html;
            }
        };
    </script>

    {# Block pour les modals additionnels des apps - doit être au niveau du body #}
    {% block extra_modals %}
    {% endblock %}

    <!-- jQuery (pour compatibilité avec le code existant) -->
    <script src="{% static 'js/jquery-3.1.1.min.js' %}"></script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jstree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js"></script>
    <!-- FileManager JS -->
    <script src="{% static 'filemanager/js/filemanager.js' %}"></script>
    <!-- System stats monitor -->
    <script src="{% static 'common/js/system-stats.js' %}"></script>

    {% block javascript %}
      <script src="{% static 'vendors/bootstrap-wysiwyg/js/bootstrap-wysiwyg.min.js' %}"></script>
    {% endblock %}
  </body>
</html>